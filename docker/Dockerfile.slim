# Slim Dockerfile for single PostgreSQL version (faster build, smaller image)
# Usage: docker build -t a5pg:slim -f docker/Dockerfile.slim --build-arg PG_VERSION=17 .

ARG PG_VERSION=17
FROM rust:1.89-slim AS builder

ARG PG_VERSION

# Install minimal build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    wget \
    gnupg \
    lsb-release \
    build-essential \
    libssl-dev \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

# Add PostgreSQL APT repository
RUN sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list' \
    && wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | gpg --dearmor -o /etc/apt/trusted.gpg.d/postgresql.gpg

# Install only the requested PostgreSQL version
RUN apt-get update && apt-get install -y --no-install-recommends \
    postgresql-${PG_VERSION} \
    postgresql-server-dev-${PG_VERSION} \
    && rm -rf /var/lib/apt/lists/*

# Install cargo-pgrx and sccache
RUN cargo install cargo-pgrx --locked && \
    cargo install sccache --locked && \
    rm -rf /usr/local/cargo/registry/cache && \
    rm -rf /usr/local/cargo/git/db

# Set up pgrx
RUN cargo pgrx init --pg${PG_VERSION} /usr/lib/postgresql/${PG_VERSION}/bin/pg_config

# Set permissions
RUN chmod -R a+w /usr/share/postgresql/${PG_VERSION}/extension && \
    chmod -R a+w /usr/lib/postgresql/${PG_VERSION}/lib

# Create non-root user
RUN useradd -m -s /bin/bash pgrxuser && \
    mkdir -p /home/pgrxuser/.pgrx && \
    cp -r /root/.pgrx/* /home/pgrxuser/.pgrx/ && \
    chown -R pgrxuser:pgrxuser /home/pgrxuser && \
    chown -R pgrxuser:pgrxuser /usr/local/cargo

USER pgrxuser
WORKDIR /workspace

# Configure cargo (CARGO_INCREMENTAL=0 required for sccache)
ENV RUSTC_WRAPPER=sccache \
    SCCACHE_DIR=/home/pgrxuser/.cache/sccache \
    CARGO_INCREMENTAL=0

# Cache dependencies
COPY --chown=pgrxuser:pgrxuser Cargo.toml Cargo.lock ./
RUN mkdir -p src && \
    echo "fn main() {}" > src/lib.rs && \
    cargo build --no-default-features --features pg${PG_VERSION} || true && \
    rm -rf src target/debug/deps/a5pg* && \
    sccache --show-stats

# Copy source
COPY --chown=pgrxuser:pgrxuser . .

CMD ["/bin/bash"]
